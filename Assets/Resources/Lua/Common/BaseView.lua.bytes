local BaseView = _MOE.class("BaseView")

local function GetControlName(control)
    if not control then
        return
    end
    return control.gameObj.name
end

function BaseView:Ctor(gameObj)
    self.bp = {}
    self.RootGameObject = gameObj
    self.RootTransform = gameObj.transform
end

function BaseView:GetTransform()
    return self.RootTransform
end

function BaseView:GetLayerId()
    return self.LayerId
end

-- 清理调所有delegete
function BaseView:ClearUIEvents()
    if self.__UIEvents then
        for name, params in pairs(self.__UIEvents) do
            local ctl = self:GetControl(name)
            if ctl then
                for eventName, _ in pairs(params) do
                    if eventName and string.len(eventName) > 0 then
                        if ctl[eventName] then
                            ctl[eventName] = nil
                        end
                    end
                end
            end
        end
        self.__UIEvents = nil
    end
end

function BaseView:_RegisterUIEvent(name, eventName, func)
    self.__UIEvents = self.__UIEvents or {}
    local ctl = self:GetControl(name)
    if ctl then
        local params = self.__UIEvents[name]
        if not params then
            params = {}
            self.__UIEvents[name] = params
        end
        params[eventName] = func
        ctl[eventName] = func
        return true
    end
    return false
end

function BaseView:_UnRegisterUIEvent(name, eventName)
    if self.__UIEvents then
        local ctl = self:GetControl(name)
        if ctl then
            local params = self.__UIEvents[name]
            if params then
                params[eventName] = nil
                if next(params) == nil then
                    self.__UIEvents[name] = nil
                end
            end
            ctl[eventName] = nil
            return true
        end
    end
    return false
end

function BaseView:_ClearAllUIControls()
    self.bp = {}
    self.Loader = nil
    self.RootGameObject = nil
    self.RootTransform = nil
end

function BaseView:GetControl(name)
    if not self.bp or not name then
        return
    end
    local ret = self.bp[name]
    return ret
end

-- Lua上的加载器
function BaseView:GetLoader()
    local ret = self.Loader
    return ret
end

function BaseView:Open(...)
    xpcall(self.OnOpen, _G.ErrorHandler, self, ...)
end

function BaseView:Close()
    xpcall(self.OnClose, _G.ErrorHandler, self)
end

--- UI释放
function BaseView:Destroy()
    xpcall(self.OnDestroy, _G.ErrorHandler, self)
    self:ClearUIEvents()
    self:_ClearAllUIControls()
end

function BaseView:ReOpen(...)
    xpcall(self.OnReOpen, _G.ErrorHandler, self, ...)
end

function BaseView:AddUIEvent(control, eventName, func)
    if not eventName or not func or not control then
        return false
    end
    if type(eventName) ~= "string" or type(func) ~= "function" then
        _MOE.Logger.LogError("[BaseView] AddUIEvent: Param is not vaild~!")
        return false
    end

    return self:_RegisterUIEvent(GetControlName(control), eventName, func)
end

function BaseView:RemoveUIEvent(control, eventName)
    if not eventName or not control then
        return false
    end
    if type(eventName) ~= "string" then
        _MOE.Logger.LogError("[BaseView] RemoveUIEvent: Param is not vaild~!")
        return false
    end
    return self:_UnRegisterUIEvent(GetControlName(control), eventName)
end

--------------------------------------- 虚方法
function BaseView:OnDestroy()
end

function BaseView:OnOpen(...)
end

function BaseView:OnReOpen(...)
end

function BaseView:OnClose()
end

return BaseView