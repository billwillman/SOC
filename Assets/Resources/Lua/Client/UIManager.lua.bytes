require("Client.Views.UIConfig")

-- UI管理器
local UIManager = _MOE.class("UIManager")
local BaseResLoaderAsyncType = typeof(CS.NSLib.ResMgr.BaseResLoaderAsyncMono)
local UIBinderType = typeof(CS.SOC.GamePlay.UIBinder)
local UILayerClass = require("Client.UILayer")

function UIManager:Ctor()
    self.Wnds = {}
    -- 创建层
    self:_CreateLayers()
end

function UIManager:_CreateLayers()
    self.Layers = {}
    if UILayerClass.Type then
        for _, layerId in pairs(UILayerClass.Type) do
            if layerId then
                self.Layers[layerId] = UILayerClass.New(layerId)
            end
        end
    end
end

function UIManager:_CreateUIPrefab(wndName)
    if not wndName then
        return
    end
    local path = _MOE.WindowResPath[wndName]
    if not path then
        return
    end
    path = string.format("Resources/UI/%s.prefab", path)
    local ret = _MOE.ResourceManager:CreateGameObject(path)
    local loader = nil
    if ret then
        loader = ret:AddComponent(BaseResLoaderAsyncType)
    end
    return ret, loader
end

function UIManager:GetWindowView(wndName)
    if not wndName then
        return
    end
    local view = self.Wnds[wndName]
    return view
end

function UIManager:_CreateUIWindow(wndName, ...)
    if not wndName then
        return
    end
    local viewClassPath = _MOE.WindowViewClass[wndName]
    if not viewClassPath or string.len(viewClassPath) <= 0 then
        return
    end
    local viewClass = require(viewClassPath)
    if not viewClass then
        return
    end
    local gameObj, loader = self:_CreateUIPrefab(wndName)
    if not gameObj then
        return
    end
    local view = viewClass.New(gameObj)
    if view then
        view.Loader = loader -- 设置加载器
        local UIBinder = gameObj:GetComponent(UIBinderType)
        if UIBinder then
            UIBinder:InitRegisterControls(view)
        end
        self.Wnds[wndName] = view
        view:Open(...)
    end
    return view
end

-- 打开界面
function UIManager:OpenWindow(wndName, ...)
    if not wndName then
        return
    end
    local view = self:GetWindowView(wndName)
    if view then
        view:ReOpen(...)
        return view
    end
    view = self:_CreateUIWindow(wndName, ...)
    return view
end

function UIManager:_FreeWindow(wndName)
    if not wndName then
        return
    end
    local view = self.Wnds[wndName]
    if view then
        local gameObj = view.RootGameObject
        view:Destroy()
        self.Wnds[wndName] = nil
        -- 删除GameObject
        if gameObj then
            _MOE.GameObject.Destroy(gameObj)
        end
    end
end

function UIManager:CloseWindow(wndName)
    if not wndName then
        return
    end
    local view = self.Wnds[wndName]
    if view then
        view:Close()
        ---- 释放流程
        self:_FreeWindow(wndName)
    end
end

return UIManager