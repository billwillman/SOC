-- 网络客户端Model
local NetClientModel = _MOE.class("NetClientModel", _MOE.BaseModel)
local MsgIds = require("_NetMsg.MsgId")

--- 请求服务器列表
function NetClientModel:OnInit()
    _MOE.Logger.Log("[NetClientModel] OnInit...")
    local jsonStr = _MOE.ResourceManager:LoadText("Resources/@Config/Server.json")
    self.HttpServerList =_MOE.Json.decode(jsonStr)
    self.HttpServerListClient = nil
    self:RegsterCSharpEvent(_MOE.NetManager, "OnConnectResult", self._OnGSConnectResult)
    self:RegsterCSharpEvent(_MOE.NetManager, "OnSocketAbort", self._OnGSSocketAbort)
    self.m_HeartTimer = _MOE.TimerManager:AddLoopTimer(0.3, self, self._OnHeartTimer)
end

function NetClientModel:IsGsConnected()
    local state = _MOE.NetManager.ClietnState
    local ret = state == _MOE.NetState.eClient_STATE_CONNECTED
    return ret
end

function NetClientModel:_OnHeartTimer()
    -- 心跳包
    if self:IsGsConnected() then
        self:SendMsg(MsgIds.CM_Heart)
    end
end

local function DisposeHttpServerClient(self)
    if self.HttpServerListClient then
        self.HttpServerListClient:Dispose()
        self.HttpServerListClient = nil
    end
end

function NetClientModel:_OnGSConnectResult(isOk)
    if isOk then
        _MOE.Logger.LogFormat("[NetClientModel] GSConnnectResult: {0}", isOk)
    else
        _MOE.Logger.LogErrorFormat("[NetClientModel] GSConnnectResult: {0}", isOk)
    end
end

function NetClientModel:_OnGSSocketAbort()
    _MOE.Logger.LogError("[NetClientModel] SocketAbort")
end

function NetClientModel:UnInit()
    DisposeHttpServerClient(self)
    _MOE.NetManager:Disconnect()
    _MOE.NetManager.OnConnectResult = nil
    _MOE.NetManager.OnSocketAbort = nil
    if self.m_HeartTimer then
        _MOE.TimerManager:RemoveTimer(self.m_HeartTimer)
        self.m_HeartTimer = nil
    end
end

function NetClientModel:GetHttpServerList()
    return self.HttpServerList
end

-- 连接GS服务器
function NetClientModel:ConnectGSServer()
    local gsData = self:GetSelectGsData()
    if not gsData then
        return
    end
    _MOE.NetManager:ConnectServer(gsData.ip, gsData.port, true)
end

function NetClientModel:GetServerList()
    return self.ServerList
end

function NetClientModel:GetSelectServerIndex()
    return self.SelectServerIndex
end

function NetClientModel:GetSelectGsData()
    if not self.ServerList then
        return
    end
    local selIndex = self:GetSelectServerIndex()
    if not selIndex then
        return
    end
    local ret = self.ServerList[selIndex]
    return ret
end

-- 请求Http的GS服务器信息
function NetClientModel:ReqHttpServerListData(selectIdx)
    if not self.HttpServerList then
        return false
    end
    selectIdx = selectIdx or 1
    local httpData = self.HttpServerList[selectIdx]
    if not httpData then
        return false
    end
    DisposeHttpServerClient(self)
    local txtRep = _MOE.HttpStrResponse()
    local url = httpData.url
    if url[string.len(url)] ~= "/" then
        url = url .. "/"
    end
    url = url .. "serverlist"
    self.HttpServerListClient = _MOE.HttpHelper.OpenUrl(url, txtRep, function (client, status)
        if self.HttpServerListClient == client then
            if status == _MOE.HttpListenerStatus.hsDone then
                self.HttpServerListClient = nil
                -- 完成了
                print(txtRep.Txt)
                self.ServerList = _MOE.Json.decode(txtRep.Txt)
                self.SelectServerIndex = 1
                _MOE.EventManager:DispatchEvent(_MOE.ClientEvents.Client_RepServerList, self.ServerList)
            elseif status == _MOE.HttpListenerStatus.hsError then
                self.HttpServerListClient = nil
                _MOE.Logger.LogError("[ReqHttpServerListData] Error")
            end
        end
    end)
    return self.HttpServerListClient ~= nil
end

-- 请求游戏地图，游戏类型
function NetClientModel:ReqDsAddr(mapId, gameType)
end

-- 连接Ds服务器
function NetClientModel:ConnectDsAddr(dsAddr)
end

---------------------------------------- 客户端协议 ----------------------------------------
function NetClientModel:CM_Login(userName, password)
    local data = {
        userName = userName,
        password = password
    }
    self:SendMsg(MsgIds.CM_Login, data)
end

function NetClientModel:SendMsg(msgId, data)
    data = data or {}
    data.msgId = msgId
    local msg = _MOE.Json.encode(data)
    _MOE.NetManager:SendMoonStr(msg)
end

return NetClientModel